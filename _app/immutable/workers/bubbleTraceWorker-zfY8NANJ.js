(function(){"use strict";function B(i,c){const u=(i!=null?i:"").trim();return u.length>0?u:`AA:${c}`}const K={soldier:15e3,tank:1250,aircraft:75,ship:15,infra:1};function P(i,c){let u=[],f=[],x=[],p=[];for(let r=0;r<c.length;r++){let o=c[r],l=i.metric_names.indexOf(o.name);if(l==-1)return console.error(`Metric ${o.name} not found`),null;u.push(l);let E=i.metrics_turn.includes(l);if(x.push(E),f.push(E?i.metrics_turn.indexOf(l):i.metrics_day.indexOf(l)),f[r]==-1)return console.error(`Metric ${o.name} not found ${l}`),null;if(o.normalize){let C=K[o.name];p.push(C|0)}else p.push(-1)}let n=x.reduce((r,o)=>r||o,!1);return{metric_ids:u,metric_indexes:f,metric_is_turn:x,metric_normalize:p,isAnyTurn:n}}function Y(i,c,u,f,x,p){let n={x:[0,Number.MIN_SAFE_INTEGER],y:[0,Number.MIN_SAFE_INTEGER],z:[0,Number.MIN_SAFE_INTEGER]};const r=["x","y","z"];let o=[c,u,f];const l=P(i,o);if(!l)return null;let E=l.metric_indexes,C=l.metric_is_turn,q=l.metric_normalize,I=l.isAnyTurn,b={},v=1/0,O=-1/0;for(let M=0;M<i.coalitions.length;M++){let t=i.coalitions[M],k=t.cities.findIndex(a=>a>=x),_=t.cities.slice().reverse().findIndex(a=>a<=p);_!==-1&&(_=t.cities.length-1-_),k==-1&&(k=0),_==-1&&(_=t.cities.length);let F=t.turn.range[0],R=t.day.range[0],H=I?F:R,J=I?t.turn.range[1]:t.day.range[1];for(let a=0;a<t.alliance_ids.length;a++){let G=t.alliance_ids[a],L=B(t.alliance_names[a],G),m=[0,0,0],w=-1;for(let s=H;s<=J;s++){s<v&&(v=s),s>O&&(O=s);let A=b[s];A||(A={},b[s]=A);let d=A[M];d||(d={x:[],y:[],id:[],text:[],customdata:[],marker:{size:[]}},A[M]=d),d.id.push(G),d.text.push(L);let Q=I?s:Math.floor(s*12),N=I?Math.floor(s/12):s;for(let e=0;e<o.length;e++){let y=C[e];if(!y&&w==N)continue;let V=o[e].cumulative,D=E[e],U=y?t.turn.data[D][a]:t.day.data[D][a];if(!U)continue;let S=U[y?Q-F:N-R];if(!S||S.length==0)continue;let T=0;for(let h=k;h<=_;h++)T+=S[h];let $=q[e];if($!=-1){let h=0,j=t.day.data[0][a];if(!j)continue;let z=j[N-R];if(!z||z.length==0)continue;if($==0)for(let g=k;g<=_;g++)h+=z[g];else for(let g=k;g<=_;g++){let W=t.cities[g];h+=z[g]*W*$}h!=0&&(T/=h)}V?m[e]+=T:m[e]=T}d.x.push(m[0]),d.y.push(m[1]),d.customdata.push(m[2]);for(let e=0;e<3;e++){let y=r[e];m[e]<n[y][0]&&(n[y][0]=m[e]),m[e]>n[y][1]&&(n[y][1]=m[e])}w=N}}}return{traces:b,times:{start:v,end:O,is_turn:I},ranges:n}}self.onmessage=i=>{const{id:c,data:u,metrics:f,minCity:x,maxCity:p}=i.data;try{const n=Y(u,f[0],f[1],f[2],x,p),r={id:c,ok:!0,result:n};self.postMessage(r)}catch(n){const r={id:c,ok:!1,error:n instanceof Error?n.message:"Unknown worker error"};self.postMessage(r)}}})();
