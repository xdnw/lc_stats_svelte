import{k as j}from"./runtime.Bz3ZCnid.js";import{l as H}from"./disclose-version.BGVnXwSC.js";import{i as Q}from"./props.CYdPwHoV.js";import{a as V}from"./Progress.KQ1k3Mu0.js";import"./binary.C_HE3RDK.js";import{r as Y,t as G}from"./warWeb.da6xX1jT.js";function L(r,e,n){if(r.multiple)return X(r,e);for(var t of r.options){var a=f(t);if(Q(a,e)){t.selected=!0;return}}(!n||e!==void 0)&&(r.selectedIndex=-1)}function U(r,e){j(()=>{var n=new MutationObserver(()=>{var t=r.__value;L(r,t)});return n.observe(r,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),()=>{n.disconnect()}})}function dr(r,e){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:e;var t=!0;H(r,"change",()=>{var a;if(r.multiple)a=[].map.call(r.querySelectorAll(":checked"),f);else{var i=r.querySelector(":checked");a=i&&f(i)}n(a)}),j(()=>{var a=e();if(L(r,a,t),t&&a===void 0){var i=r.querySelector(":checked");i!==null&&(a=f(i),n(a))}r.__value=a,t=!1}),U(r)}function X(r,e){for(var n of r.options)n.selected=~e.indexOf(f(n))}function f(r){return"__value"in r?r.__value:r.value}function pr(r,e){var n,t,a,i,c;const l=r.coalitions[0].alliance_ids,J=r.coalitions[1].alliance_ids,d=[...l,...J],I=r.war_web.headers.indexOf(e.header);if(I<0)return[];const A=r.war_web.data[I],S={};r.coalitions.forEach(o=>{o.alliance_ids.forEach((s,u)=>{S[s]=V(o.alliance_names[u],s)})});const $=e.primaryIds.map(o=>d.indexOf(o)).filter(o=>o>=0),q=e.vsIds.map(o=>d.indexOf(o)).filter(o=>o>=0),p=[];let v=0,y=0;for(const o of q){let s=0,u=0;for(const k of $){const N=(t=(n=A[k])==null?void 0:n[o])!=null?t:0,x=(i=(a=A[o])==null?void 0:a[k])!=null?i:0;s+=Number.isFinite(N)?N:0,u+=Number.isFinite(x)?x:0}v+=s,y+=u;const _=d[o];p.push({alliance:[(c=S[_])!=null?c:`AA:${_}`,_],primary_to_row:s,row_to_primary:u,net:s-u,total:s+u,primary_share_pct:0,row_share_pct:0,abs_net:Math.abs(s-u)})}return p.forEach(o=>{o.primary_share_pct=v>0?o.primary_to_row/v*100:0,o.row_share_pct=y>0?o.row_to_primary/y*100:0}),p}const vr=["primary_to_row","row_to_primary","net","total","primary_share_pct","row_share_pct","abs_net"];function Z(r){const e=Y(r);return{primary_to_row:e.primaryToRowLabel(r),row_to_primary:e.rowToPrimaryLabel(r),net:"Net",total:"Total",primary_share_pct:"Selected share %",row_share_pct:"Compared share %",abs_net:"Abs Net"}}function yr(r,e){var n;return(n=Z(e)[r])!=null?n:G(r)}var rr=Object.defineProperty,z=Object.getOwnPropertySymbols,er=Object.prototype.hasOwnProperty,nr=Object.prototype.propertyIsEnumerable,F=(r,e,n)=>e in r?rr(r,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):r[e]=n,g=(r,e)=>{for(var n in e||(e={}))er.call(e,n)&&F(r,n,e[n]);if(z)for(var n of z(e))nr.call(e,n)&&F(r,n,e[n]);return r};const tr=new Set(["duration","wars","damage-total","net-gap","c1-dealt","c2-dealt","participation"]),b={version:1,widgets:[]};function ar(r){const e=(r!=null?r:"").trim();return e.length>0?e:"unknown"}function D(r){return`lc_stats:conflict:${ar(r)}:kpi-config`}function _r(r){try{const e=D(r),n=localStorage.getItem(e);if(!n)return g({},b);const t=JSON.parse(n);return!t||typeof t!="object"?g({},b):{version:1,widgets:Array.isArray(t.widgets)?t.widgets:[]}}catch(e){return console.warn("Failed to read shared KPI config",e),g({},b)}}function gr(r,e){var n;try{const t=D(r);localStorage.setItem(t,JSON.stringify({version:1,widgets:(n=e.widgets)!=null?n:[]}))}catch(t){console.warn("Failed to save shared KPI config",t)}}function h(r){return`${r}-${Math.random().toString(36).slice(2,10)}`}function O(r){return r==="all"||r==="coalition1"||r==="coalition2"||r==="selection"}function w(r){if(!r||typeof r!="object")return;const e=r,n=Array.isArray(e.allianceIds)?e.allianceIds.map(i=>Number(i)).filter(i=>Number.isFinite(i)):[],t=Array.isArray(e.nationIds)?e.nationIds.map(i=>Number(i)).filter(i=>Number.isFinite(i)):[],a=typeof e.label=="string"?e.label:"Selection snapshot";return{allianceIds:n,nationIds:t,label:a}}function P(r){if(!r||typeof r!="object")return;const e=r,n=e.primaryCoalitionIndex===1?1:0,t=typeof e.header=="string"?e.header:"wars",a=typeof e.label=="string"?e.label:"AAvA snapshot",i=Array.isArray(e.primaryIds)?e.primaryIds.map(l=>Number(l)).filter(l=>Number.isFinite(l)):[],c=Array.isArray(e.vsIds)?e.vsIds.map(l=>Number(l)).filter(l=>Number.isFinite(l)):[];return{primaryCoalitionIndex:n,header:t,label:a,primaryIds:i,vsIds:c}}function m(r){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:h;if(!r||typeof r!="object")return null;const n=r;if(n.kind==="preset")return tr.has(n.key)?{id:typeof n.id=="string"?n.id:e("preset"),kind:"preset",key:n.key}:null;if(n.kind==="ranking"){if(!(n.entity==="alliance"||n.entity==="nation")||!O(n.scope)||typeof n.metric!="string")return null;const t=w(n.snapshot),a=P(n.aavaSnapshot);return{id:typeof n.id=="string"?n.id:e("ranking"),kind:"ranking",entity:n.entity,metric:n.metric,scope:n.scope,limit:Math.max(1,Number(n.limit)||10),source:n.source==="aava"?"aava":"conflict",snapshot:t,aavaSnapshot:a}}if(n.kind==="metric"){if(!(n.entity==="alliance"||n.entity==="nation")||!O(n.scope)||!(n.aggregation==="sum"||n.aggregation==="avg")||typeof n.metric!="string")return null;const t=w(n.snapshot),a=P(n.aavaSnapshot);return{id:typeof n.id=="string"?n.id:e("metric"),kind:"metric",entity:n.entity,metric:n.metric,scope:n.scope,aggregation:n.aggregation,source:n.source==="aava"?"aava":"conflict",normalizeBy:typeof n.normalizeBy=="string"?n.normalizeBy:null,snapshot:t,aavaSnapshot:a}}return null}function E(r){if(r==="coalition1")return"c1";if(r==="coalition2")return"c2";if(r==="selection")return"sel"}function K(r){return r==="c1"?"coalition1":r==="c2"?"coalition2":r==="sel"?"selection":"all"}function C(r){return r==="alliance"?"a":"n"}function M(r){return r==="a"?"alliance":"nation"}function W(r){var e,n;if(!r)return;const t=(e=r.allianceIds)!=null&&e.length?[...r.allianceIds]:void 0,a=(n=r.nationIds)!=null&&n.length?[...r.nationIds]:void 0;if(!(!t&&!a))return{a:t,n:a}}function B(r){if(r)return{allianceIds:Array.isArray(r.a)?r.a.map(e=>Number(e)).filter(e=>Number.isFinite(e)):[],nationIds:Array.isArray(r.n)?r.n.map(e=>Number(e)).filter(e=>Number.isFinite(e)):[],label:"Selection snapshot"}}function T(r){var e,n;if(!r)return;const t=r.header&&r.header!=="wars"?r.header:void 0,a=(e=r.primaryIds)!=null&&e.length?[...r.primaryIds]:void 0,i=(n=r.vsIds)!=null&&n.length?[...r.vsIds]:void 0;if(!(!t&&!a&&!i))return{h:t,p:a,v:i}}function R(r){if(r)return{header:typeof r.h=="string"?r.h:"wars",primaryCoalitionIndex:0,primaryIds:Array.isArray(r.p)?r.p.map(e=>Number(e)).filter(e=>Number.isFinite(e)):[],vsIds:Array.isArray(r.v)?r.v.map(e=>Number(e)).filter(e=>Number.isFinite(e)):[],label:"AAvA snapshot"}}function ir(r){return r.kind==="preset"?{k:"p",p:r.key}:r.kind==="ranking"?{k:"r",e:C(r.entity),m:r.metric,s:E(r.scope),l:r.limit!==10?Math.max(1,Number(r.limit)||10):void 0,z:r.source==="aava"?"a":void 0,ss:r.scope==="selection"?W(r.snapshot):void 0,as:r.source==="aava"?T(r.aavaSnapshot):void 0}:{k:"m",e:C(r.entity),m:r.metric,s:E(r.scope),g:r.aggregation==="avg"?"a":void 0,n:typeof r.normalizeBy=="string"&&r.normalizeBy.length>0?r.normalizeBy:void 0,z:r.source==="aava"?"a":void 0,ss:r.scope==="selection"?W(r.snapshot):void 0,as:r.source==="aava"?T(r.aavaSnapshot):void 0}}function or(r){if(!r||typeof r!="object")return null;const e=r;return e.k==="p"?m({kind:"preset",key:e.p}):e.k==="r"?!(e.e==="a"||e.e==="n")||typeof e.m!="string"?null:m({kind:"ranking",entity:M(e.e),metric:e.m,scope:K(e.s),limit:Number(e.l)||10,source:e.z==="a"?"aava":"conflict",snapshot:B(e.ss),aavaSnapshot:R(e.as)}):e.k==="m"?!(e.e==="a"||e.e==="n")||typeof e.m!="string"?null:m({kind:"metric",entity:M(e.e),metric:e.m,scope:K(e.s),aggregation:e.g==="a"?"avg":"sum",source:e.z==="a"?"aava":"conflict",normalizeBy:typeof e.n=="string"?e.n:null,snapshot:B(e.ss),aavaSnapshot:R(e.as)}):null}function br(r){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:h;try{if(!r||r.length===0)return null;const n=r.map(t=>m(t,e)).filter(t=>t!==null).map(t=>ir(t)).filter(t=>t!==null);return n.length===0?null:JSON.stringify(n)}catch(n){return console.warn("Failed to serialize compact KPI widgets",n),null}}function hr(r){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:h;try{const n=JSON.parse(r);return Array.isArray(n)?n.map(t=>or(t)).filter(t=>t!==null).map(t=>m(t,e)):[]}catch(n){return[]}}function Ir(r,e,n){const t=[...r],a=t.findIndex(l=>l.id===e);if(a===-1)return r;const i=a+n;if(i<0||i>=t.length)return r;const[c]=t.splice(a,1);return t.splice(i,0,c),t}function Ar(r,e,n){const t=[...r],a=t.findIndex(c=>c.id===e);if(a===-1||a===n||n<0||n>=t.length)return r;const[i]=t.splice(a,1);return t.splice(n,0,i),t}export{vr as A,pr as a,dr as b,m as c,br as d,yr as e,Ir as f,Z as g,Ar as h,h as m,hr as p,_r as r,gr as s};
