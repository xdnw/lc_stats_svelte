import{b as J}from"./DqDmrPFw.js";import"./BLlCKcKh.js";import{r as H,t as Q}from"./C-5gSOKl.js";const x=new WeakMap;function V(r){const e=x.get(r);if(e)return e;const n=r.coalitions[0].alliance_ids,t=r.coalitions[1].alliance_ids,a=[...n,...t],i=new Map;for(let u=0;u<a.length;u++)i.set(a[u],u);const c={};r.coalitions.forEach(u=>{u.alliance_ids.forEach((p,d)=>{c[p]=J(u.alliance_names[d],p)})});const l={allAllianceIds:a,indexByAllianceId:i,allianceNameById:c};return x.set(r,l),l}function ar(r,e){var n,t,a,i,c;const{allAllianceIds:l,indexByAllianceId:u,allianceNameById:p}=V(r),d=r.war_web.headers.indexOf(e.header);if(d<0)return[];const A=r.war_web.data[d],L=e.primaryIds.map(o=>{var s;return(s=u.get(o))!=null?s:-1}).filter(o=>o>=0),D=e.vsIds.map(o=>{var s;return(s=u.get(o))!=null?s:-1}).filter(o=>o>=0),y=[];let v=0,g=0;for(const o of D){let s=0,m=0;for(const S of L){const k=(t=(n=A[S])==null?void 0:n[o])!=null?t:0,N=(i=(a=A[o])==null?void 0:a[S])!=null?i:0;s+=Number.isFinite(k)?k:0,m+=Number.isFinite(N)?N:0}v+=s,g+=m;const _=l[o];y.push({alliance:[(c=p[_])!=null?c:"AA:".concat(_),_],primary_to_row:s,row_to_primary:m,net:s-m,total:s+m,primary_share_pct:0,row_share_pct:0,abs_net:Math.abs(s-m)})}return y.forEach(o=>{o.primary_share_pct=v>0?o.primary_to_row/v*100:0,o.row_share_pct=g>0?o.row_to_primary/g*100:0}),y}const ir=["primary_to_row","row_to_primary","net","total","primary_share_pct","row_share_pct","abs_net"];function Y(r){const e=H(r);return{primary_to_row:e.primaryToRowLabel(r),row_to_primary:e.rowToPrimaryLabel(r),net:"Net",total:"Total",primary_share_pct:"Selected share %",row_share_pct:"Compared share %",abs_net:"Abs Net"}}function or(r,e){var n;return(n=Y(e)[r])!=null?n:Q(r)}var G=Object.defineProperty,w=Object.getOwnPropertySymbols,U=Object.prototype.hasOwnProperty,q=Object.prototype.propertyIsEnumerable,z=(r,e,n)=>e in r?G(r,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):r[e]=n,I=(r,e)=>{for(var n in e||(e={}))U.call(e,n)&&z(r,n,e[n]);if(w)for(var n of w(e))q.call(e,n)&&z(r,n,e[n]);return r};const X=new Set(["duration","wars","damage-total","net-gap","c1-dealt","c2-dealt","off-wars-per-nation"]),b={version:1,widgets:[]};function Z(r){const e=(r!=null?r:"").trim();return e.length>0?e:"unknown"}function j(r){return"lc_stats:conflict:".concat(Z(r),":kpi-config")}function lr(r){try{const e=j(r),n=localStorage.getItem(e);if(!n)return I({},b);const t=JSON.parse(n);return!t||typeof t!="object"?I({},b):{version:1,widgets:Array.isArray(t.widgets)?t.widgets:[]}}catch(e){return console.warn("Failed to read shared KPI config",e),I({},b)}}function sr(r,e){var n;try{const t=j(r);localStorage.setItem(t,JSON.stringify({version:1,widgets:(n=e.widgets)!=null?n:[]}))}catch(t){console.warn("Failed to save shared KPI config",t)}}function h(r){return"".concat(r,"-").concat(Math.random().toString(36).slice(2,10))}function F(r){return r==="all"||r==="coalition1"||r==="coalition2"||r==="selection"}function P(r){if(!r||typeof r!="object")return;const e=r,n=Array.isArray(e.allianceIds)?e.allianceIds.map(i=>Number(i)).filter(i=>Number.isFinite(i)):[],t=Array.isArray(e.nationIds)?e.nationIds.map(i=>Number(i)).filter(i=>Number.isFinite(i)):[],a=typeof e.label=="string"?e.label:"Selection snapshot";return{allianceIds:n,nationIds:t,label:a}}function C(r){if(!r||typeof r!="object")return;const e=r,n=e.primaryCoalitionIndex===1?1:0,t=typeof e.header=="string"?e.header:"wars",a=typeof e.label=="string"?e.label:"AAvA snapshot",i=Array.isArray(e.primaryIds)?e.primaryIds.map(l=>Number(l)).filter(l=>Number.isFinite(l)):[],c=Array.isArray(e.vsIds)?e.vsIds.map(l=>Number(l)).filter(l=>Number.isFinite(l)):[];return{primaryCoalitionIndex:n,header:t,label:a,primaryIds:i,vsIds:c}}function f(r){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:h;if(!r||typeof r!="object")return null;const n=r;if(n.kind==="preset")return X.has(n.key)?{id:typeof n.id=="string"?n.id:e("preset"),kind:"preset",key:n.key}:null;if(n.kind==="ranking"){if(!(n.entity==="alliance"||n.entity==="nation")||!F(n.scope)||typeof n.metric!="string")return null;const t=P(n.snapshot),a=C(n.aavaSnapshot);return{id:typeof n.id=="string"?n.id:e("ranking"),kind:"ranking",entity:n.entity,metric:n.metric,scope:n.scope,limit:Math.max(1,Number(n.limit)||10),source:n.source==="aava"?"aava":"conflict",snapshot:t,aavaSnapshot:a}}if(n.kind==="metric"){if(!(n.entity==="alliance"||n.entity==="nation")||!F(n.scope)||!(n.aggregation==="sum"||n.aggregation==="avg")||typeof n.metric!="string")return null;const t=P(n.snapshot),a=C(n.aavaSnapshot);return{id:typeof n.id=="string"?n.id:e("metric"),kind:"metric",entity:n.entity,metric:n.metric,scope:n.scope,aggregation:n.aggregation,source:n.source==="aava"?"aava":"conflict",normalizeBy:typeof n.normalizeBy=="string"?n.normalizeBy:null,snapshot:t,aavaSnapshot:a}}return null}function E(r){if(r==="coalition1")return"c1";if(r==="coalition2")return"c2";if(r==="selection")return"sel"}function K(r){return r==="c1"?"coalition1":r==="c2"?"coalition2":r==="sel"?"selection":"all"}function O(r){return r==="alliance"?"a":"n"}function B(r){return r==="a"?"alliance":"nation"}function M(r){var e,n;if(!r)return;const t=(e=r.allianceIds)!=null&&e.length?[...r.allianceIds]:void 0,a=(n=r.nationIds)!=null&&n.length?[...r.nationIds]:void 0;if(!(!t&&!a))return{a:t,n:a}}function W(r){if(r)return{allianceIds:Array.isArray(r.a)?r.a.map(e=>Number(e)).filter(e=>Number.isFinite(e)):[],nationIds:Array.isArray(r.n)?r.n.map(e=>Number(e)).filter(e=>Number.isFinite(e)):[],label:"Selection snapshot"}}function T(r){var e,n;if(!r)return;const t=r.header&&r.header!=="wars"?r.header:void 0,a=(e=r.primaryIds)!=null&&e.length?[...r.primaryIds]:void 0,i=(n=r.vsIds)!=null&&n.length?[...r.vsIds]:void 0;if(!(!t&&!a&&!i))return{h:t,p:a,v:i}}function R(r){if(r)return{header:typeof r.h=="string"?r.h:"wars",primaryCoalitionIndex:0,primaryIds:Array.isArray(r.p)?r.p.map(e=>Number(e)).filter(e=>Number.isFinite(e)):[],vsIds:Array.isArray(r.v)?r.v.map(e=>Number(e)).filter(e=>Number.isFinite(e)):[],label:"AAvA snapshot"}}function $(r){return r.kind==="preset"?{k:"p",p:r.key}:r.kind==="ranking"?{k:"r",e:O(r.entity),m:r.metric,s:E(r.scope),l:r.limit!==10?Math.max(1,Number(r.limit)||10):void 0,z:r.source==="aava"?"a":void 0,ss:r.scope==="selection"?M(r.snapshot):void 0,as:r.source==="aava"?T(r.aavaSnapshot):void 0}:{k:"m",e:O(r.entity),m:r.metric,s:E(r.scope),g:r.aggregation==="avg"?"a":void 0,n:typeof r.normalizeBy=="string"&&r.normalizeBy.length>0?r.normalizeBy:void 0,z:r.source==="aava"?"a":void 0,ss:r.scope==="selection"?M(r.snapshot):void 0,as:r.source==="aava"?T(r.aavaSnapshot):void 0}}function rr(r){if(!r||typeof r!="object")return null;const e=r;return e.k==="p"?f({kind:"preset",key:e.p}):e.k==="r"?!(e.e==="a"||e.e==="n")||typeof e.m!="string"?null:f({kind:"ranking",entity:B(e.e),metric:e.m,scope:K(e.s),limit:Number(e.l)||10,source:e.z==="a"?"aava":"conflict",snapshot:W(e.ss),aavaSnapshot:R(e.as)}):e.k==="m"?!(e.e==="a"||e.e==="n")||typeof e.m!="string"?null:f({kind:"metric",entity:B(e.e),metric:e.m,scope:K(e.s),aggregation:e.g==="a"?"avg":"sum",source:e.z==="a"?"aava":"conflict",normalizeBy:typeof e.n=="string"?e.n:null,snapshot:W(e.ss),aavaSnapshot:R(e.as)}):null}function cr(r){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:h;try{if(!r||r.length===0)return null;const n=r.map(t=>f(t,e)).filter(t=>t!==null).map(t=>$(t)).filter(t=>t!==null);return n.length===0?null:JSON.stringify(n)}catch(n){return console.warn("Failed to serialize compact KPI widgets",n),null}}function ur(r){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:h;try{const n=JSON.parse(r);return Array.isArray(n)?n.map(t=>rr(t)).filter(t=>t!==null).map(t=>f(t,e)):[]}catch(n){return[]}}function mr(r,e,n){const t=[...r],a=t.findIndex(l=>l.id===e);if(a===-1)return r;const i=a+n;if(i<0||i>=t.length)return r;const[c]=t.splice(a,1);return t.splice(i,0,c),t}function fr(r,e,n){const t=[...r],a=t.findIndex(c=>c.id===e);if(a===-1||a===n||n<0||n>=t.length)return r;const[i]=t.splice(a,1);return t.splice(n,0,i),t}export{ir as A,cr as a,ar as b,f as c,or as d,mr as e,fr as f,Y as g,h as m,ur as p,lr as r,sr as s};
